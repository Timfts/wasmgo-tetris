replicate c++ version with functional approach
refactor using uber fx